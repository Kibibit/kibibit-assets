<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>X Person Card</title>
  <style>
    :root {
      --bg: #fff;
      --fg: #0b0b0c;
      --muted: #6b7280;
      --hair: #e5e7eb;
      --link: #111;
      --chip: #f3f4f6;
    }

    [data-theme="dark"] {
      --bg: #0b0b0c;
      --fg: #f1f5f9;
      --muted: #94a3b8;
      --hair: #1f2937;
      --link: #e5e7eb;
      --chip: #111827;
    }

    html,
    body {
      margin: 0;
      height: 100dvh;
      background: transparent;
      color: var(--fg);
      font: 14px/1.45 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
    }

    a {
      color: var(--link);
      text-decoration: none
    }

    a:hover {
      text-decoration: underline
    }

    .card {
      max-width: 520px;
      border: 1px solid var(--hair);
      border-radius: 12px;
      padding: 14px;
      background: var(--bg);
      display: flex;
      flex-direction: column;
    }

    [data-expand="true"] .card {
      height: calc(100% - 28px - 2px);
    }

    .expander {
      flex-grow: 0;
    }

    [data-expand="true"] .expander {
      flex-grow: 1;
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--hair);
    }

    .name {
      font-weight: 700;
      font-size: 16px;
    }

    .handle {
      color: var(--muted);
    }

    .bio {
      margin: 6px 0 10px;
      color: var(--fg)
    }

    .latest {
      border-top: 1px solid var(--hair);
      padding-top: 10px;
      margin-top: 10px;
    }

    .meta {
      color: var(--muted);
      font-size: 12px;
      margin-top: 6px;
    }

    .actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      background: var(--chip);
      border: 1px solid var(--hair);
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 600;
      display: flex;
      align-items: center;
    }

    .chip svg {
      flex-shrink: 0;
    }

    .loader {
      color: var(--muted);
      padding: 10px 0
    }

    /* compact mode */
    .compact .bio {
      display: none
    }

    .compact .latest {
      display: none
    }

    .kb-logo {
      height: 1.2em;
      margin-right: 0.5em;
      fill: var(--fg);
    }
  </style>
</head>

<body>
  <div id="app" class="card">
    <div class="loader">Loading…</div>
  </div>
  <script>
    (async function () {
      const qs = new URLSearchParams(location.search);
      const user = (qs.get("u") || "openai").replace(/^@/, ''); // ?u=handle
      const theme = (qs.get("theme") || "light"); // ?theme=dark|light
      const compact = qs.has("compact"); // ?compact
      const expand = qs.has("expand"); // ?expand
      const refresh = Math.max(0, parseInt(qs.get("refresh") || "0", 10)); // ?refresh=120 (seconds)
      const nitter = qs.get("nitter") || "https://nitter.net"; // override instance if needed
      // 5 days
      const CACHE_TTL = 5 * 24 * 60 * 60;
      const ttlSec = qs.get("ttl") || CACHE_TTL;
      const CACHE_NS = "xpcache_v1";                                  // namespace for this widget
      const LRU_LIMIT = 10;

      const defaultCache = {
        'andrewyng': {"ts": Date.now(),"data":{"display":"andrewyng","user":"andrewyng","bio":"Co-Founder of Coursera; Stanford CS adjunct faculty. Former head of Baidu AI Group/Google Brain. #ai #machinelearning, #deeplearning #MOOCs","avatar":"https://unavatar.io/twitter/andrewyng","profileURL":"https://nitter.net/andrewyng"}},
        'officiallogank': {"ts":Date.now(),"data":{"display":"OfficialLoganK","user":"OfficialLoganK","bio":"Lead product for @GoogleAIStudio + the Gemini API. My views!","avatar":"https://unavatar.io/twitter/OfficialLoganK","profileURL":"https://nitter.net/OfficialLoganK"}},
        'openai': {"ts":Date.now(),"data":{"display":"OpenAI","user":"OpenAI","bio":"OpenAI’s mission is to ensure that artificial general intelligence benefits all of humanity. We’re hiring: openai.com/jobs","avatar":"https://unavatar.io/twitter/OpenAI","profileURL":"https://nitter.net/OpenAI"}},
        'sama': {"ts":Date.now(),"data":{"display":"sama","user":"sama","bio":"AI is cool i guess","avatar":"https://unavatar.io/twitter/sama","profileURL":"https://nitter.net/sama"}},
        'theo': {"ts":Date.now(),"data":{"display":"theo","user":"theo","bio":"Full time CEO @t3dotchat. Part time YouTuber, investor, and developer","avatar":"https://unavatar.io/twitter/theo","profileURL":"https://nitter.net/theo"}}
      };

      Object.entries(defaultCache).forEach(([key, value]) => {
        setCache(key, "https://nitter.net", value.data);
      });

      document.documentElement.setAttribute("data-theme", theme);
      if (expand) document.documentElement.setAttribute("data-expand", "true");
      const app = document.getElementById("app");

      if (compact) app.classList.add("compact");

      const prox = async (url) => {
        try {
          const r = await fetch(
            `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`
            // url
          );

          if (r.ok) {
            const text = await r.json();
            if (!text) {
              throw new Error("No text");
            }
            return text.contents;
          }
          throw 0;
        } catch {
          throw 0;
        }
      };

      async function fetchFresh(user, nitterBase){
        const profileURL = `${nitterBase}/${user}`;
        const rssURL = `${nitterBase}/${user}/rss`;
        const [html, rss] = await Promise.all([prox(profileURL), prox(rssURL)]);
        const { display, bio } = parseProfile(html, user);
        const avatar = `https://unavatar.io/twitter/${encodeURIComponent(user)}`;
        return { display, user, bio, avatar, profileURL };
      }

      function parseProfile(html, user){
        let display = user;
        const titleMatch = html.match(/<title>([^<]+) \/ /);
        if (titleMatch) display = titleMatch[1].trim();
        const bioMatch = html.match(/<div class="profile-bio">([\s\S]*?)<\/div>/);
        const bio = bioMatch ? bioMatch[1].replace(/<[^>]+>/g,'').trim() : "";
        return { display, bio };
      }

      async function render() {
        // ---------- Flow ----------
        // 1) Try cache first (instant render)
        const cached = getCache(user, nitter);
        if (cached){
          renderCard(cached);
        } else {
          app.innerHTML = `<div class="loader">Loading…</div>`;
        }

        // 2) If no cache or cache is old (we always refresh in the background),
        //    fetch fresh and update + store.
        try{
          const data = await fetchFresh(user, nitter);
          renderCard(data);
          setCache(user, nitter, data);
        }catch(e){
          // If cache already rendered, keep it; else show error
          if (!cached){
            app.innerHTML = `<div class="loader">Failed to load. Try again later.</div>`;
          }
          console.error(e);
        }
      }

      await render();

      if (refresh > 0) {
        setInterval(() => {
          if (document.hasFocus && document.hasFocus()) render();
        }, refresh * 1000);
      }

      // ---------- Cache (LRU + TTL) ----------
      function now() { return Date.now(); }
      function kFor(u, nitterBase) { return `${CACHE_NS}:${nitterBase}:${u.toLowerCase()}`; }
      function readJSON(k) { try { return JSON.parse(localStorage.getItem(k) || "null"); } catch { return null; } }
      function writeJSON(k, v) { try { localStorage.setItem(k, JSON.stringify(v)); } catch { } }
      function touchLRU(k) {
        const idxKey = `${CACHE_NS}:index`;
        const idx = readJSON(idxKey) || [];
        const filtered = idx.filter(x => x !== k);
        filtered.unshift(k);
        while (filtered.length > LRU_LIMIT) {
          const drop = filtered.pop();
          if (drop) localStorage.removeItem(drop);
        }
        writeJSON(idxKey, filtered);
      }
      function getCache(u, nitterBase) {
        const key = kFor(u, nitterBase);
        const entry = readJSON(key);
        if (!entry) return null;
        if ((now() - entry.ts) > ttlSec * 1000) return null; // expired
        // Update LRU order on read
        touchLRU(key);
        return entry.data;
      }
      function setCache(u, nitterBase, data) {
        const key = kFor(u, nitterBase);
        writeJSON(key, { ts: now(), data });
        touchLRU(key);
      }

      function renderCard({display, user, bio, avatar, profileURL}){
        app.innerHTML = `
          <div class="row">
            <img class="avatar" src="${avatar}" alt="${display} avatar" referrerpolicy="no-referrer">
            <div>
              <div class="name">${display}</div>
              <div class="handle">@${user}</div>
            </div>
          </div>
          <div class="bio">${bio || ""}</div>
          <div class="expander"></div>
          <div class="actions">
            <a class="chip follow" href="https://x.com/${user}" target="_blank" rel="noopener">
              <svg class="kb-logo" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>X</title>
                <path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/>
              </svg>
              Follow
            </a>
            <a class="chip" href="${profileURL}" target="_blank" rel="noopener">
              <img src="https://nitter.net/logo.png" class="kb-logo" alt="Nitter">
              Nitter
            </a>
          </div>
        `;
      }
    })();
  </script>
</body>

</html>
